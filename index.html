<script>
        const API_URL = 'https://game-analysis.onrender.com/';
        const MY_PASSWORD = "izumi"; 

        // ログインチェック
        function checkPassword() {
            const input = document.getElementById('pass-input').value;
            const error = document.getElementById('login-error');
            if (input === MY_PASSWORD) {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('main-content').classList.remove('hidden');
                sessionStorage.setItem('isLoggedIn', 'true');
            } else {
                if (error) error.classList.remove('hidden');
            }
        }

        // ページ読み込み時の処理
        window.onload = () => {
            if (sessionStorage.getItem('isLoggedIn') === 'true') {
                const loginScreen = document.getElementById('login-screen');
                const mainContent = document.getElementById('main-content');
                if (loginScreen) loginScreen.classList.add('hidden');
                if (mainContent) mainContent.classList.remove('hidden');
            }
        };

        // 表示のリセット
        function resetDisplay() {
            const thoughtArea = document.getElementById('user-thought');
            if (thoughtArea) thoughtArea.value = "";
            document.getElementById('result-section').classList.add('hidden');
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('input-section').classList.remove('hidden');
            document.getElementById('original-text-container').classList.add('hidden');
            document.getElementById('accordion-icon').style.transform = 'rotate(0deg)';
            window.scrollTo(0, 0);
        }

        // 入力内容の表示切り替え
        function toggleOriginalText() {
            const container = document.getElementById('original-text-container');
            const icon = document.getElementById('accordion-icon');
            if (!container) return;
            const isHidden = container.classList.contains('hidden');
            if (isHidden) {
                container.classList.remove('hidden');
                if (icon) icon.style.transform = 'rotate(180deg)';
            } else {
                container.classList.add('hidden');
                if (icon) icon.style.transform = 'rotate(0deg)';
            }
        }

        // 分析実行
        async function analyzeThought() {
            const thought = document.getElementById('user-thought').value.trim();
            if (!thought) return;
            
            document.getElementById('display-user-thought').innerText = thought;
            document.getElementById('input-section').classList.add('hidden');
            document.getElementById('loading').classList.remove('hidden');
            
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        "thought": thought,
                        "mode": document.getElementById('mode-toggle').checked ? "strict" : "flexible"
                    })
                });
                
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                let data = await response.json();

                // --- サーバー側からのエラー応答を検知する処理を追加 ---
                if (data.error) {
                    alert(`【分析中断】\n${data.error}\n詳細: ${data.detail || "なし"}`);
                    resetDisplay();
                    return;
                }

                if (typeof data === 'string') data = JSON.parse(data);

                document.getElementById('loading').classList.add('hidden');
                document.getElementById('result-section').classList.remove('hidden');
                
                const getVal = (obj, keys) => {
                    if (!obj) return "-";
                    for (let key of keys) {
                        let target = obj[key];
                        if (target !== undefined && target !== null && target !== "") {
                            if (typeof target === 'object' && !Array.isArray(target)) {
                                return target.message || target.text || target.content || JSON.stringify(target);
                            }
                            return target;
                        }
                    }
                    return "-";
                };

                const setB = (id, val) => {
                    const el = document.getElementById(id);
                    if (!el) return;
                    const v = String(val || "-").toUpperCase();
                    el.innerText = v;
                    el.className = 'ok-badge ' + (v.includes('NOT') ? 'badge-not-ok' : v.includes('OK') ? 'badge-ok' : 'badge-none');
                };

                const jpName = getVal(data, ['game_name', '心理ゲーム']);
                const enName = getVal(data, ['english_name', '英語名']);
                document.getElementById('game-name').innerText = (enName !== "-" && !jpName.includes(enName)) ? `${jpName} (${enName})` : jpName;

                document.getElementById('game-definition').innerText = getVal(data, ['definition', '解説']);
                document.getElementById('game-scenario').innerText = getVal(data, ['scenario', '要約']);
                document.getElementById('prediction').innerText = getVal(data, ['prediction', '予測']);
                document.getElementById('hidden-motive').innerText = getVal(data, ['hidden_motive', '利得']);
                document.getElementById('advice').innerText = getVal(data, ['advice', '回避策']);
                document.getElementById('counseling-msg').innerText = getVal(data, ['counseling', 'カウンセリング']);

                const sName = getVal(data, ['subject_name', '自分']);
                if (sName !== "-") {
                    document.getElementById('label-start').innerHTML = `▶ 開始時 (${sName}視点)`;
                    document.getElementById('label-end').innerHTML = `▼ 結末 (${sName}視点)`;
                }

                const s = data.position_start || data.start_position || {};
                const e = data.position_end || data.end_position || {};
                
                setB('pos-start-self', getVal(s, ['self', '自分']));
                setB('pos-start-others', getVal(s, ['others', '相手']));
                document.getElementById('pos-start-desc').innerText = getVal(s, ['description', '解説']);
                
                setB('pos-end-self', getVal(e, ['self', '自分']));
                setB('pos-end-others', getVal(e, ['others', '相手']));
                document.getElementById('pos-end-desc').innerText = getVal(e, ['description', '解説']);

            } catch (err) {
                console.error(err);
                alert("通信エラーが発生しました。Renderサーバーが起動中か、タイムアウトした可能性があります。1分ほど置いて再度お試しください。");
                resetDisplay();
            }
        }
    </script>